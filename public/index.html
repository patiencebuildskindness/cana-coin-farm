<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CANA Coin Farm - MVP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #gameContainer {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
        }

        #gameHeader {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        #gameStats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin: 5px;
            font-weight: bold;
        }

        #gameArea {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        #farmCanvas {
            border: 3px solid #333;
            border-radius: 10px;
            background: #8bc34a;
            cursor: crosshair;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #controls {
            flex: 1;
            min-width: 250px;
        }

        .controlSection {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .controlSection h3 {
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        #inventory {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .inventoryItem {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .inventoryItem:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .inventoryItem.selected {
            border-color: #667eea;
            background: #e8eaf6;
            transform: scale(1.05);
        }

        .inventoryItem .emoji {
            font-size: 1.5em;
            display: block;
        }

        .inventoryItem .count {
            font-size: 0.8em;
            color: #666;
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }

        button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #actionButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .plotInfo {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 0.9em;
        }

        #instructions {
            background: #fffde7;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
        }

        #instructions h4 {
            color: #f57c00;
            margin-bottom: 5px;
        }

        #instructions ul {
            margin-left: 20px;
            color: #666;
        }

        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: none;
            animation: fadeInOut 2s ease;
            z-index: 2000;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameHeader">
            <h1>üå± CANA Coin Farm üå±</h1>
            <div id="gameStats">
                <div class="stat">Day: <span id="day">1</span></div>
                <div class="stat">Season: <span id="season">Spring</span></div>
                <div class="stat">Coins: <span id="coins">100</span></div>
                <div class="stat">Energy: <span id="energy">100</span>/100</div>
            </div>
        </div>

        <div id="instructions">
            <h4>üéÆ How to Play:</h4>
            <ul>
                <li>Use Arrow Keys or WASD to move your character</li>
                <li>Click on plots to interact</li>
                <li>Select seeds from inventory to plant</li>
                <li>Water plants daily for growth</li>
                <li>Harvest when ready!</li>
            </ul>
        </div>

        <div id="gameArea">
            <canvas id="farmCanvas" width="500" height="500"></canvas>
            
            <div id="controls">
                <div class="controlSection">
                    <h3>üéí Inventory</h3>
                    <div id="inventory"></div>
                </div>

                <div class="controlSection">
                    <h3>‚ö° Actions</h3>
                    <div id="actionButtons">
                        <button onclick="game.waterPlot()">üíß Water</button>
                        <button onclick="game.harvestPlot()">üåæ Harvest</button>
                        <button onclick="game.tillSoil()">üî® Till Soil</button>
                        <button onclick="game.expandLand()" id="expandBtn">üèóÔ∏è Expand (500 coins)</button>
                    </div>
                </div>

                <div class="controlSection">
                    <h3>üìä Plot Info</h3>
                    <div class="plotInfo" id="plotInfo">
                        Select a plot to see details
                    </div>
                </div>

                <div class="controlSection">
                    <h3>üè™ Market</h3>
                    <button onclick="game.openMarket()">Open Market</button>
                    <button onclick="game.advanceDay()">üåô Sleep (Next Day)</button>
                </div>

                <div class="controlSection">
                    <h3>üíæ Save Management</h3>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Auto-save: ON (every 30s)<br>
                        Last save: <span id="lastSave">Never</span>
                    </div>
                    <button onclick="game.saveGame() && game.showTooltip('Game saved!')">üíæ Save Now</button>
                    <button onclick="game.exportSave()">üì• Export Save</button>
                    <button onclick="document.getElementById('importFile').click()">üì§ Import Save</button>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="game.importSave(this.files[0])">
                    <button onclick="game.deleteSave()" style="background: linear-gradient(135deg, #e53935, #c62828);">üóëÔ∏è Delete Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip"></div>
    <div class="save-indicator" id="saveIndicator">üîÑ Saving...</div>

    <script>
        // Game Constants
        const TILE_SIZE = 50;
        const INITIAL_GRID_SIZE = 10;
        const SEASONS = ['Spring', 'Summer', 'Fall', 'Winter'];
        const DAYS_PER_SEASON = 30;

        // Plant Database (Starting with 10 from the 369)
        const PLANTS = {
            tomato: {
                name: 'Tomato',
                emoji: 'üçÖ',
                growthTime: 5,
                stages: ['üå±', 'üåø', 'üåø', 'üåø', 'üçÖ'],
                basePrice: 15,
                seedCost: 5,
                season: ['Spring', 'Summer'],
                waterNeeded: 3,
                category: 'vegetable'
            },
            carrot: {
                name: 'Carrot',
                emoji: 'ü•ï',
                growthTime: 4,
                stages: ['üå±', 'üåø', 'üåø', 'ü•ï'],
                basePrice: 10,
                seedCost: 3,
                season: ['Spring', 'Fall'],
                waterNeeded: 2,
                category: 'vegetable'
            },
            lettuce: {
                name: 'Lettuce',
                emoji: 'ü•¨',
                growthTime: 3,
                stages: ['üå±', 'üåø', 'ü•¨'],
                basePrice: 8,
                seedCost: 2,
                season: ['Spring', 'Fall'],
                waterNeeded: 4,
                category: 'vegetable'
            },
            basil: {
                name: 'Basil',
                emoji: 'üåø',
                growthTime: 3,
                stages: ['üå±', 'üåø', 'üåø'],
                basePrice: 12,
                seedCost: 4,
                season: ['Spring', 'Summer'],
                waterNeeded: 2,
                category: 'herb'
            },
            mint: {
                name: 'Mint',
                emoji: 'üåø',
                growthTime: 3,
                stages: ['üå±', 'üåø', 'üåø'],
                basePrice: 10,
                seedCost: 3,
                season: ['Spring', 'Summer', 'Fall'],
                waterNeeded: 3,
                category: 'herb'
            },
            rosemary: {
                name: 'Rosemary',
                emoji: 'üåø',
                growthTime: 6,
                stages: ['üå±', 'üåø', 'üåø', 'üåø', 'üåø', 'üåø'],
                basePrice: 18,
                seedCost: 6,
                season: ['Spring', 'Summer', 'Fall'],
                waterNeeded: 1,
                category: 'herb'
            },
            sunflower: {
                name: 'Sunflower',
                emoji: 'üåª',
                growthTime: 7,
                stages: ['üå±', 'üåø', 'üåø', 'üåø', 'üåø', 'üåø', 'üåª'],
                basePrice: 20,
                seedCost: 8,
                season: ['Summer'],
                waterNeeded: 3,
                category: 'flower'
            },
            marigold: {
                name: 'Marigold',
                emoji: 'üèµÔ∏è',
                growthTime: 4,
                stages: ['üå±', 'üåø', 'üåø', 'üèµÔ∏è'],
                basePrice: 12,
                seedCost: 4,
                season: ['Spring', 'Summer', 'Fall'],
                waterNeeded: 2,
                category: 'flower',
                companion: true  // Good companion plant
            },
            wheat: {
                name: 'Wheat',
                emoji: 'üåæ',
                growthTime: 8,
                stages: ['üå±', 'üåø', 'üåø', 'üåø', 'üåø', 'üåø', 'üåø', 'üåæ'],
                basePrice: 25,
                seedCost: 10,
                season: ['Spring', 'Fall'],
                waterNeeded: 2,
                category: 'grain'
            },
            apple: {
                name: 'Apple Tree',
                emoji: 'üçé',
                growthTime: 20,
                stages: ['üå±', 'üåø', 'üå≥', 'üå≥', 'üå≥', 'üçé'],
                basePrice: 50,
                seedCost: 20,
                season: ['Spring'],
                waterNeeded: 3,
                category: 'tree',
                perennial: true  // Keeps producing
            }
        };

        // Character Class
        class Character {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.energy = 100;
                this.sprite = 'üë®‚Äçüåæ';
                this.facing = 'down';
                this.animationFrame = 0;
            }

            move(dx, dy, gridSize) {
                const newX = this.x + dx;
                const newY = this.y + dy;
                
                if (newX >= 0 && newX < gridSize && newY >= 0 && newY < gridSize) {
                    if (this.energy > 0) {
                        this.x = newX;
                        this.y = newY;
                        this.energy = Math.max(0, this.energy - 1);
                        this.animationFrame = (this.animationFrame + 1) % 2;
                        
                        // Update facing direction
                        if (dx > 0) this.facing = 'right';
                        else if (dx < 0) this.facing = 'left';
                        else if (dy > 0) this.facing = 'down';
                        else if (dy < 0) this.facing = 'up';
                    }
                }
            }

            rest() {
                this.energy = 100;
            }

            draw(ctx, tileSize) {
                ctx.save();
                ctx.font = `${tileSize * 0.7}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Add simple animation
                const offset = this.animationFrame * 2;
                const x = this.x * tileSize + tileSize / 2;
                const y = this.y * tileSize + tileSize / 2 + offset;
                
                // Draw shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillText(this.sprite, x + 2, y + 2);
                
                // Draw character
                ctx.fillStyle = '#000';
                ctx.fillText(this.sprite, x, y);
                
                ctx.restore();
            }
        }

        // Plot Class
        class Plot {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.tilled = false;
                this.plant = null;
                this.growthStage = 0;
                this.watered = false;
                this.daysWithoutWater = 0;
                this.health = 100;
                this.harvestReady = false;
            }

            till() {
                this.tilled = true;
                this.plant = null;
                this.growthStage = 0;
                this.harvestReady = false;
            }

            plantSeed(plantType) {
                if (this.tilled && !this.plant) {
                    this.plant = plantType;
                    this.growthStage = 0;
                    this.health = 100;
                    return true;
                }
                return false;
            }

            water() {
                this.watered = true;
                this.daysWithoutWater = 0;
            }

            grow() {
                if (this.plant && !this.harvestReady) {
                    const plantData = PLANTS[this.plant];
                    
                    if (this.watered) {
                        this.growthStage++;
                        if (this.growthStage >= plantData.growthTime) {
                            this.harvestReady = true;
                        }
                    } else {
                        this.daysWithoutWater++;
                        this.health = Math.max(0, this.health - 10);
                        if (this.health === 0) {
                            this.plant = null;  // Plant dies
                        }
                    }
                    
                    this.watered = false;  // Reset for next day
                }
            }

            harvest() {
                if (this.harvestReady) {
                    const harvested = this.plant;
                    if (!PLANTS[this.plant].perennial) {
                        this.plant = null;
                        this.growthStage = 0;
                        this.harvestReady = false;
                        this.tilled = false;
                    } else {
                        // Perennial plants keep producing
                        this.growthStage = PLANTS[this.plant].growthTime - 1;
                        this.harvestReady = false;
                    }
                    return harvested;
                }
                return null;
            }

            draw(ctx, tileSize) {
                const x = this.x * tileSize;
                const y = this.y * tileSize;
                
                // Base soil
                if (this.tilled) {
                    ctx.fillStyle = '#8B4513';
                } else {
                    ctx.fillStyle = '#90EE90';
                }
                ctx.fillRect(x, y, tileSize, tileSize);
                
                // Watered effect
                if (this.watered) {
                    ctx.fillStyle = 'rgba(0, 100, 200, 0.3)';
                    ctx.fillRect(x, y, tileSize, tileSize);
                }
                
                // Grid lines
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.strokeRect(x, y, tileSize, tileSize);
                
                // Draw plant
                if (this.plant) {
                    const plantData = PLANTS[this.plant];
                    ctx.save();
                    ctx.font = `${tileSize * 0.6}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const stage = Math.min(this.growthStage, plantData.stages.length - 1);
                    const emoji = this.harvestReady ? plantData.emoji : plantData.stages[stage];
                    
                    // Health affects opacity
                    ctx.globalAlpha = this.health / 100;
                    ctx.fillText(emoji, x + tileSize / 2, y + tileSize / 2);
                    
                    // Show if harvest ready
                    if (this.harvestReady) {
                        ctx.fillStyle = 'gold';
                        ctx.font = '12px Arial';
                        ctx.fillText('‚ú®', x + tileSize - 10, y + 10);
                    }
                    
                    ctx.restore();
                }
            }
        }

        // Main Game Class
        class FarmGame {
            constructor() {
                this.canvas = document.getElementById('farmCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gridSize = INITIAL_GRID_SIZE;
                this.plots = [];
                this.character = new Character(0, 0);
                this.selectedItem = null;
                this.coins = 100;
                this.day = 1;
                this.season = 0;
                
                // Try to load saved game
                if (!this.loadGame()) {
                    // No save found, initialize new game
                    this.inventory = this.initializeInventory();
                    this.initializeGrid();
                } else {
                    // Game loaded successfully
                    this.showTooltip('Game loaded successfully!');
                }
                
                // Set up controls
                this.setupControls();
                
                // Set up auto-save
                this.setupAutoSave();
                
                // Start game loop
                this.gameLoop();
            }

            initializeInventory() {
                const inventory = {};
                const plantKeys = Object.keys(PLANTS);
                
                // Give player 3 random seed types to start
                for (let i = 0; i < 3; i++) {
                    const randomPlant = plantKeys[Math.floor(Math.random() * plantKeys.length)];
                    inventory[randomPlant] = (inventory[randomPlant] || 0) + 5;
                }
                
                return inventory;
            }

            initializeGrid() {
                this.plots = [];
                for (let y = 0; y < this.gridSize; y++) {
                    for (let x = 0; x < this.gridSize; x++) {
                        this.plots.push(new Plot(x, y));
                    }
                }
            }

            getPlot(x, y) {
                return this.plots.find(p => p.x === x && p.y === y);
            }

            setupControls() {
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    switch(e.key.toLowerCase()) {
                        case 'arrowup':
                        case 'w':
                            this.character.move(0, -1, this.gridSize);
                            break;
                        case 'arrowdown':
                        case 's':
                            this.character.move(0, 1, this.gridSize);
                            break;
                        case 'arrowleft':
                        case 'a':
                            this.character.move(-1, 0, this.gridSize);
                            break;
                        case 'arrowright':
                        case 'd':
                            this.character.move(1, 0, this.gridSize);
                            break;
                        case ' ':
                            this.interactWithCurrentPlot();
                            break;
                    }
                    this.updateUI();
                    this.draw();
                });

                // Mouse controls
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = Math.floor((e.clientX - rect.left) / TILE_SIZE);
                    const y = Math.floor((e.clientY - rect.top) / TILE_SIZE);
                    
                    if (x === this.character.x && y === this.character.y) {
                        this.interactWithCurrentPlot();
                    } else {
                        // Move character to clicked position (pathfinding simplified)
                        this.character.x = Math.min(Math.max(0, x), this.gridSize - 1);
                        this.character.y = Math.min(Math.max(0, y), this.gridSize - 1);
                        this.character.energy = Math.max(0, this.character.energy - 2);
                    }
                    
                    this.updateUI();
                    this.draw();
                });
            }

            interactWithCurrentPlot() {
                const plot = this.getPlot(this.character.x, this.character.y);
                if (!plot) return;
                
                if (this.selectedItem && this.inventory[this.selectedItem] > 0) {
                    if (plot.plantSeed(this.selectedItem)) {
                        this.inventory[this.selectedItem]--;
                        if (this.inventory[this.selectedItem] === 0) {
                            delete this.inventory[this.selectedItem];
                            this.selectedItem = null;
                        }
                    }
                }
                
                this.updateUI();
            }

            tillSoil() {
                const plot = this.getPlot(this.character.x, this.character.y);
                if (plot && this.character.energy >= 5) {
                    plot.till();
                    this.character.energy -= 5;
                    this.updateUI();
                    this.draw();
                }
            }

            waterPlot() {
                const plot = this.getPlot(this.character.x, this.character.y);
                if (plot && plot.plant && this.character.energy >= 2) {
                    plot.water();
                    this.character.energy -= 2;
                    this.updateUI();
                    this.draw();
                }
            }

            harvestPlot() {
                const plot = this.getPlot(this.character.x, this.character.y);
                if (plot && plot.harvestReady) {
                    const harvested = plot.harvest();
                    if (harvested) {
                        const plantData = PLANTS[harvested];
                        const price = this.calculateMarketPrice(harvested);
                        this.coins += price;
                        this.showTooltip(`Harvested ${plantData.name} for ${price} coins!`);
                    }
                    this.updateUI();
                    this.draw();
                }
            }

            calculateMarketPrice(plantType) {
                const plantData = PLANTS[plantType];
                let price = plantData.basePrice;
                
                // Season bonus
                if (plantData.season.includes(SEASONS[this.season])) {
                    price *= 1.2;
                }
                
                // Random market fluctuation
                price *= (0.8 + Math.random() * 0.4);
                
                return Math.round(price);
            }

            advanceDay() {
                this.day++;
                
                // Season change
                if (this.day % DAYS_PER_SEASON === 0) {
                    this.season = (this.season + 1) % SEASONS.length;
                }
                
                // Grow all plants
                this.plots.forEach(plot => plot.grow());
                
                // Restore energy
                this.character.rest();
                
                this.updateUI();
                this.draw();
            }

            expandLand() {
                if (this.coins >= 500 && this.gridSize < 15) {
                    this.coins -= 500;
                    this.gridSize += 2;
                    
                    // Add new plots
                    for (let y = 0; y < this.gridSize; y++) {
                        for (let x = 0; x < this.gridSize; x++) {
                            if (x >= this.gridSize - 2 || y >= this.gridSize - 2) {
                                if (!this.getPlot(x, y)) {
                                    this.plots.push(new Plot(x, y));
                                }
                            }
                        }
                    }
                    
                    // Resize canvas
                    this.canvas.width = this.gridSize * TILE_SIZE;
                    this.canvas.height = this.gridSize * TILE_SIZE;
                    
                    this.updateUI();
                    this.draw();
                }
            }

            openMarket() {
                let marketHTML = '<h3>üè™ Market</h3>';
                marketHTML += '<div style="max-height: 400px; overflow-y: auto;">';
                
                Object.entries(PLANTS).forEach(([key, plant]) => {
                    const canBuy = this.coins >= plant.seedCost;
                    const inSeason = plant.season.includes(SEASONS[this.season]);
                    
                    marketHTML += `
                        <div style="padding: 10px; border: 1px solid #ddd; margin: 5px; border-radius: 5px; ${!canBuy ? 'opacity: 0.5;' : ''}">
                            <span style="font-size: 1.5em;">${plant.emoji}</span>
                            <strong>${plant.name}</strong>
                            <br>Cost: ${plant.seedCost} coins
                            <br>Sells for: ~${plant.basePrice} coins
                            <br>Season: ${plant.season.join(', ')}
                            ${inSeason ? '<span style="color: green;">‚úì In Season</span>' : '<span style="color: red;">‚úó Out of Season</span>'}
                            <br><button onclick="game.buySeeds('${key}')" ${!canBuy ? 'disabled' : ''}>Buy Seeds</button>
                        </div>
                    `;
                });
                
                marketHTML += '</div>';
                
                // Simple modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 1000; max-width: 500px;';
                modal.innerHTML = marketHTML + '<button onclick="this.parentElement.remove()">Close</button>';
                document.body.appendChild(modal);
            }

            buySeeds(plantType) {
                const plant = PLANTS[plantType];
                if (this.coins >= plant.seedCost) {
                    this.coins -= plant.seedCost;
                    this.inventory[plantType] = (this.inventory[plantType] || 0) + 3;
                    this.updateUI();
                    document.querySelector('div[style*="position: fixed"]')?.remove();
                }
            }

            showTooltip(text) {
                const tooltip = document.getElementById('tooltip');
                tooltip.textContent = text;
                tooltip.style.display = 'block';
                tooltip.style.left = '50%';
                tooltip.style.top = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                
                setTimeout(() => {
                    tooltip.style.display = 'none';
                }, 2000);
            }

            updateUI() {
                // Update stats
                document.getElementById('day').textContent = this.day;
                document.getElementById('season').textContent = SEASONS[this.season];
                document.getElementById('coins').textContent = this.coins;
                document.getElementById('energy').textContent = this.character.energy;
                
                // Update last save time
                document.getElementById('lastSave').textContent = this.getTimeSinceLastSave();
                
                // Update inventory
                const inventoryDiv = document.getElementById('inventory');
                inventoryDiv.innerHTML = '';
                
                Object.entries(this.inventory).forEach(([plant, count]) => {
                    const plantData = PLANTS[plant];
                    const item = document.createElement('div');
                    item.className = 'inventoryItem';
                    if (this.selectedItem === plant) {
                        item.classList.add('selected');
                    }
                    item.innerHTML = `
                        <span class="emoji">${plantData.emoji}</span>
                        <div>${plantData.name}</div>
                        <div class="count">x${count}</div>
                    `;
                    item.onclick = () => {
                        this.selectedItem = this.selectedItem === plant ? null : plant;
                        this.updateUI();
                    };
                    inventoryDiv.appendChild(item);
                });
                
                // Update plot info
                const plot = this.getPlot(this.character.x, this.character.y);
                const plotInfo = document.getElementById('plotInfo');
                if (plot) {
                    let info = `Position: (${plot.x}, ${plot.y})<br>`;
                    info += `Tilled: ${plot.tilled ? 'Yes' : 'No'}<br>`;
                    if (plot.plant) {
                        const plantData = PLANTS[plot.plant];
                        info += `Plant: ${plantData.name}<br>`;
                        info += `Growth: ${plot.growthStage}/${plantData.growthTime}<br>`;
                        info += `Health: ${plot.health}%<br>`;
                        info += `Watered: ${plot.watered ? 'Yes' : 'No'}<br>`;
                        info += `Ready: ${plot.harvestReady ? 'Yes! üåü' : 'No'}`;
                    }
                    plotInfo.innerHTML = info;
                }
                
                // Update expand button
                document.getElementById('expandBtn').disabled = this.coins < 500 || this.gridSize >= 15;
            }

            draw() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw plots
                this.plots.forEach(plot => plot.draw(this.ctx, TILE_SIZE));
                
                // Draw character
                this.character.draw(this.ctx, TILE_SIZE);
                
                // Draw selection highlight
                this.ctx.strokeStyle = 'yellow';
                this.ctx.lineWidth = 3;
                this.ctx.strokeRect(
                    this.character.x * TILE_SIZE,
                    this.character.y * TILE_SIZE,
                    TILE_SIZE,
                    TILE_SIZE
                );
            }

            gameLoop() {
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            }

            // Save System Methods
            saveGame() {
                try {
                    const saveData = {
                        version: '1.0',
                        timestamp: Date.now(),
                        character: {
                            x: this.character.x,
                            y: this.character.y,
                            energy: this.character.energy
                        },
                        game: {
                            coins: this.coins,
                            day: this.day,
                            season: this.season,
                            gridSize: this.gridSize,
                            selectedItem: this.selectedItem
                        },
                        inventory: this.inventory,
                        plots: this.plots.map(plot => ({
                            x: plot.x,
                            y: plot.y,
                            tilled: plot.tilled,
                            plant: plot.plant,
                            growthStage: plot.growthStage,
                            watered: plot.watered,
                            daysWithoutWater: plot.daysWithoutWater,
                            health: plot.health,
                            harvestReady: plot.harvestReady
                        }))
                    };
                    
                    localStorage.setItem('canaFarmSave', JSON.stringify(saveData));
                    
                    // Show save indicator
                    const indicator = document.getElementById('saveIndicator');
                    indicator.style.display = 'block';
                    indicator.innerHTML = '‚úÖ Saved!';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                    
                    return true;
                } catch (error) {
                    console.error('Failed to save game:', error);
                    
                    // Show error indicator
                    const indicator = document.getElementById('saveIndicator');
                    indicator.style.display = 'block';
                    indicator.style.background = 'rgba(244, 67, 54, 0.9)';
                    indicator.innerHTML = '‚ùå Save failed!';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                        indicator.style.background = 'rgba(76, 175, 80, 0.9)';
                    }, 2000);
                    
                    return false;
                }
            }

            loadGame() {
                try {
                    const saveString = localStorage.getItem('canaFarmSave');
                    if (!saveString) return false;
                    
                    const saveData = JSON.parse(saveString);
                    
                    // Restore character
                    this.character.x = saveData.character.x;
                    this.character.y = saveData.character.y;
                    this.character.energy = saveData.character.energy;
                    
                    // Restore game state
                    this.coins = saveData.game.coins;
                    this.day = saveData.game.day;
                    this.season = saveData.game.season;
                    this.gridSize = saveData.game.gridSize;
                    this.selectedItem = saveData.game.selectedItem;
                    
                    // Restore inventory
                    this.inventory = saveData.inventory;
                    
                    // Restore plots
                    this.plots = saveData.plots.map(plotData => {
                        const plot = new Plot(plotData.x, plotData.y);
                        plot.tilled = plotData.tilled;
                        plot.plant = plotData.plant;
                        plot.growthStage = plotData.growthStage;
                        plot.watered = plotData.watered;
                        plot.daysWithoutWater = plotData.daysWithoutWater;
                        plot.health = plotData.health;
                        plot.harvestReady = plotData.harvestReady;
                        return plot;
                    });
                    
                    // Resize canvas if needed
                    if (this.gridSize !== INITIAL_GRID_SIZE) {
                        this.canvas.width = this.gridSize * TILE_SIZE;
                        this.canvas.height = this.gridSize * TILE_SIZE;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Failed to load game:', error);
                    return false;
                }
            }

            deleteSave() {
                if (confirm('Are you sure you want to delete your save and start over?')) {
                    localStorage.removeItem('canaFarmSave');
                    location.reload();
                }
            }

            exportSave() {
                const saveString = localStorage.getItem('canaFarmSave');
                if (saveString) {
                    const blob = new Blob([saveString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cana-farm-save-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showTooltip('Save exported successfully!');
                } else {
                    this.showTooltip('No save data found!');
                }
            }

            importSave(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const saveData = JSON.parse(e.target.result);
                        localStorage.setItem('canaFarmSave', e.target.result);
                        location.reload();
                    } catch (error) {
                        this.showTooltip('Invalid save file!');
                    }
                };
                reader.readAsText(file);
            }

            setupAutoSave() {
                // Auto-save every 30 seconds
                setInterval(() => {
                    if (this.saveGame()) {
                        console.log('Auto-saved at', new Date().toLocaleTimeString());
                    }
                }, 30000);
                
                // Save on important actions
                const originalAdvanceDay = this.advanceDay.bind(this);
                this.advanceDay = () => {
                    originalAdvanceDay();
                    this.saveGame();
                };
                
                const originalExpandLand = this.expandLand.bind(this);
                this.expandLand = () => {
                    originalExpandLand();
                    this.saveGame();
                };
                
                const originalBuySeeds = this.buySeeds.bind(this);
                this.buySeeds = (plantType) => {
                    originalBuySeeds(plantType);
                    this.saveGame();
                };
                
                // Save on harvest
                const originalHarvestPlot = this.harvestPlot.bind(this);
                this.harvestPlot = () => {
                    originalHarvestPlot();
                    this.saveGame();
                };
                
                // Save before page unload
                window.addEventListener('beforeunload', () => {
                    this.saveGame();
                });
            }

            getTimeSinceLastSave() {
                try {
                    const saveString = localStorage.getItem('canaFarmSave');
                    if (!saveString) return 'Never';
                    
                    const saveData = JSON.parse(saveString);
                    const timeDiff = Date.now() - saveData.timestamp;
                    const seconds = Math.floor(timeDiff / 1000);
                    
                    if (seconds < 60) return `${seconds}s ago`;
                    const minutes = Math.floor(seconds / 60);
                    if (minutes < 60) return `${minutes}m ago`;
                    const hours = Math.floor(minutes / 60);
                    if (hours < 24) return `${hours}h ago`;
                    const days = Math.floor(hours / 24);
                    return `${days}d ago`;
                } catch {
                    return 'Unknown';
                }
            }
        }

        // Start the game
        let game;
        window.onload = () => {
            game = new FarmGame();
            game.updateUI();
            
            // Update save time display every 5 seconds
            setInterval(() => {
                const lastSaveElement = document.getElementById('lastSave');
                if (lastSaveElement) {
                    lastSaveElement.textContent = game.getTimeSinceLastSave();
                }
            }, 5000);
        };
    </script>
</body>
</html>
