<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CANA - Medicinal Plant World</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a1f1b, #1a3d34);
            color: #e0f2e9;
            overflow: hidden;
            position: relative;
            height: 100vh;
        }

        /* Game World Canvas */
        .game-world {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: auto;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(74, 222, 128, 0.1) 0%, transparent 50%);
        }

        /* Top HUD */
        .top-hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(10, 31, 27, 0.98), rgba(10, 31, 27, 0.85));
            backdrop-filter: blur(10px);
            padding: 10px;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .player-level {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid #4ade80;
        }

        .level-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .resources {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(34, 197, 94, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .resource-icon {
            font-size: 16px;
        }

        .resource-amount {
            font-weight: bold;
            color: #4ade80;
        }

        /* Farm View */
        .farm-container {
            position: relative;
            padding: 80px 10px 80px 10px;
            min-height: 100vh;
        }

        .farm-grid {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            gap: 5px;
            margin: 20px auto;
            width: fit-content;
            transform: perspective(1000px) rotateX(35deg);
            transform-style: preserve-3d;
        }

        .plot {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(101, 67, 33, 0.6), rgba(78, 52, 26, 0.4));
            border: 2px solid #8b5c2e;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            transform-style: preserve-3d;
        }

        .plot:hover {
            transform: translateZ(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .plot-plant {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
            animation: sway 3s infinite ease-in-out;
        }

        @keyframes sway {
            0%, 100% { transform: translateX(-50%) rotate(-2deg); }
            50% { transform: translateX(-50%) rotate(2deg); }
        }

        .plot-timer {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
        }

        .plot-ready {
            animation: pulse 1s infinite;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.4), rgba(245, 158, 11, 0.3));
            border-color: #fbbf24;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Buildings */
        .buildings-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px auto;
            flex-wrap: wrap;
        }

        .building {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            border: 2px solid #3b82f6;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .building:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        .building-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }

        .building-name {
            font-size: 11px;
            font-weight: bold;
        }

        /* Neighbor Farms */
        .neighbors-strip {
            display: flex;
            gap: 15px;
            padding: 10px;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 10px;
        }

        .neighbor-farm {
            min-width: 80px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .neighbor-farm:hover {
            transform: scale(1.1);
        }

        .neighbor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a855f7, #9333ea);
            margin: 0 auto 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid #c084fc;
        }

        .neighbor-name {
            font-size: 11px;
            opacity: 0.9;
        }

        .neighbor-level {
            font-size: 10px;
            color: #fbbf24;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(0deg, rgba(10, 31, 27, 0.98), rgba(10, 31, 27, 0.85));
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            background: none;
            border: none;
            color: #e0f2e9;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .nav-item:hover, .nav-item.active {
            color: #4ade80;
        }

        .nav-item.active {
            background: rgba(34, 197, 94, 0.1);
            border-radius: 10px;
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 10px;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a3d34, #0f2922);
            border-radius: 20px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #22c55e;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(34, 197, 94, 0.3);
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #4ade80;
        }

        .close-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 24px;
            cursor: pointer;
        }

        /* Market */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .market-item {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .market-item:hover {
            transform: scale(1.05);
            border-color: #4ade80;
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        .market-item-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .market-item-name {
            font-size: 11px;
            margin-bottom: 3px;
        }

        .market-item-price {
            font-size: 12px;
            color: #fbbf24;
            font-weight: bold;
        }

        /* Friends List */
        .friends-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(34, 197, 94, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .friend-item:hover {
            background: rgba(34, 197, 94, 0.15);
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec4899, #db2777);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .friend-status {
            font-size: 11px;
            color: #4ade80;
        }

        .friend-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #4ade80;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #22c55e;
            color: white;
        }

        /* Factory System */
        .factory-machines {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .machine {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(147, 51, 234, 0.1));
            border: 2px solid #a855f7;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            position: relative;
        }

        .machine-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }

        .machine-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .machine-status {
            font-size: 11px;
            color: #fbbf24;
        }

        .machine-progress {
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .machine-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            transition: width 0.3s;
        }

        /* Inventory Grid */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .inventory-item {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            position: relative;
        }

        .inventory-icon {
            font-size: 30px;
        }

        .inventory-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .inventory-name {
            font-size: 10px;
            margin-top: 3px;
        }

        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            top: 80px;
            right: -300px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #0a1f1b;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: right 0.5s;
            z-index: 3000;
            max-width: 250px;
        }

        .achievement-toast.show {
            right: 20px;
        }

        .achievement-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .achievement-icon {
            font-size: 30px;
        }

        .achievement-title {
            font-weight: bold;
            font-size: 14px;
        }

        .achievement-desc {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Daily Bonus Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 15px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .calendar-day.collected {
            background: rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
        }

        .calendar-day.today {
            animation: pulse 2s infinite;
            border-color: #fbbf24;
        }

        .day-number {
            font-size: 10px;
            opacity: 0.7;
        }

        .day-reward {
            font-size: 20px;
        }

        /* Floating Notifications */
        .floating-text {
            position: fixed;
            color: #4ade80;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            animation: floatUp 2s ease-out;
            z-index: 4000;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }

        /* Weather Effects */
        .weather-indicator {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .weather-icon {
            font-size: 20px;
        }

        .weather-text {
            font-size: 12px;
        }

        /* Energy Bar */
        .energy-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 3px;
            margin: 5px 0;
        }

        .energy-bar {
            height: 20px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 7px;
            position: relative;
            transition: width 0.5s;
        }

        .energy-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- Top HUD -->
    <div class="top-hud">
        <div class="player-info">
            <div class="player-level">
                <div class="avatar">üßë‚Äçüåæ</div>
                <div>
                    <div style="font-size: 14px; font-weight: bold;">Farmer <span id="playerName">You</span></div>
                    <div class="level-badge">Level <span id="playerLevel">1</span></div>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 11px; opacity: 0.8;">Farm <span id="farmNumber">1</span>/51</div>
                <div style="font-size: 10px; color: #4ade80;">XP: <span id="playerXP">0</span>/100</div>
            </div>
        </div>
        <div class="resources">
            <div class="resource">
                <span class="resource-icon">üí∞</span>
                <span class="resource-amount" id="coins">1000</span>
            </div>
            <div class="resource">
                <span class="resource-icon">üíé</span>
                <span class="resource-amount" id="gems">10</span>
            </div>
            <div class="resource">
                <span class="resource-icon">üåø</span>
                <span class="resource-amount" id="herbs">0</span>
            </div>
            <div class="resource">
                <span class="resource-icon">üß™</span>
                <span class="resource-amount" id="extracts">0</span>
            </div>
        </div>
        <div class="energy-container">
            <div class="energy-bar" id="energyBar" style="width: 100%">
                <span class="energy-text">‚ö° <span id="energy">100</span>/100</span>
            </div>
        </div>
    </div>

    <!-- Weather Indicator -->
    <div class="weather-indicator">
        <span class="weather-icon" id="weatherIcon">‚òÄÔ∏è</span>
        <span class="weather-text" id="weatherText">Sunny</span>
    </div>

    <!-- Game World -->
    <div class="game-world" id="gameWorld">
        <!-- Farm Container -->
        <div class="farm-container" id="farmView">
            <!-- Neighbor Farms Strip -->
            <div class="neighbors-strip">
                <div class="neighbor-farm" onclick="visitNeighbor(1)">
                    <div class="neighbor-avatar">üë©</div>
                    <div class="neighbor-name">Sarah</div>
                    <div class="neighbor-level">Lvl 45</div>
                </div>
                <div class="neighbor-farm" onclick="visitNeighbor(2)">
                    <div class="neighbor-avatar">üë®</div>
                    <div class="neighbor-name">Mike</div>
                    <div class="neighbor-level">Lvl 32</div>
                </div>
                <div class="neighbor-farm" onclick="visitNeighbor(3)">
                    <div class="neighbor-avatar">üëß</div>
                    <div class="neighbor-name">Emma</div>
                    <div class="neighbor-level">Lvl 28</div>
                </div>
                <div class="neighbor-farm" onclick="visitNeighbor(4)">
                    <div class="neighbor-avatar">üßë</div>
                    <div class="neighbor-name">Alex</div>
                    <div class="neighbor-level">Lvl 51</div>
                </div>
                <div class="neighbor-farm" onclick="visitNeighbor(5)">
                    <div class="neighbor-avatar">üë¥</div>
                    <div class="neighbor-name">Elder</div>
                    <div class="neighbor-level">Lvl 127</div>
                </div>
            </div>

            <!-- Main Farm Grid -->
            <div class="farm-grid" id="farmGrid">
                <!-- 64 plots will be generated here -->
            </div>

            <!-- Buildings -->
            <div class="buildings-row">
                <div class="building" onclick="openFactory()">
                    <span class="building-icon">üè≠</span>
                    <span class="building-name">Extract Lab</span>
                </div>
                function openPlantLibrary() {
    // Create the library modal if it doesn't exist
    if (!document.getElementById('libraryModal')) {
        const libraryModalHTML = `
            <div class="modal" id="libraryModal">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <span class="modal-title">üìö Plant Encyclopedia - 369 Plants</span>
                        <button class="close-btn" onclick="closeModal('libraryModal')">‚úñ</button>
                    </div>
                    <div id="libraryContent" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', libraryModalHTML);
    }
    
    // Show all plants in a simple list
    const content = document.getElementById('libraryContent');
    let html = '<div style="display: grid; gap: 5px;">';
    
    gameState.plants.forEach(plant => {
        html += `
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; 
                        border-radius: 8px; padding: 8px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">${plant.emoji}</span>
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: #4ade80; font-size: 14px;">${plant.name}</div>
                    <div style="font-size: 11px; opacity: 0.7;">
                        Level ${plant.level} ‚Ä¢ üí∞${plant.value} ‚Ä¢ ‚è±Ô∏è${plant.growTime}s ‚Ä¢ ‚ú®${plant.xp}XP
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    content.innerHTML = html;
    document.getElementById('libraryModal').classList.add('active');
}
                <div class="building" onclick="openGreenhouse()">
                    <span class="building-icon">üè°</span>
                    <span class="building-name">Greenhouse</span>
                </div>
                <div class="building" onclick="openApothecary()">
                    <span class="building-icon">‚öóÔ∏è</span>
                    <span class="building-name">Apothecary</span>
                </div>
              <div class="building" onclick="openPlantLibrary()">
    <span class="building-icon">üìö</span>
    <span class="building-name">Library</span>
</div>
                <div class="building" onclick="openFishPond()">
                    <span class="building-icon">üé£</span>
                    <span class="building-name">Koi Pond</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="showView('farm')">
            <span class="nav-icon">üåæ</span>
            <span class="nav-label">Farm</span>
        </button>
        <button class="nav-item" onclick="showView('market')">
            <span class="nav-icon">üõí</span>
            <span class="nav-label">Market</span>
        </button>
        <button class="nav-item" onclick="showView('inventory')">
            <span class="nav-icon">üì¶</span>
            <span class="nav-label">Storage</span>
        </button>
        <button class="nav-item" onclick="showView('social')">
            <span class="nav-icon">üë•</span>
            <span class="nav-label">Co-op</span>
        </button>
        <button class="nav-item" onclick="showView('quests')">
            <span class="nav-icon">‚≠ê</span>
            <span class="nav-label">Quests</span>
        </button>
    </div>

    <!-- Market Modal -->
    <div class="modal" id="marketModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üõí Marketplace</span>
                <button class="close-btn" onclick="closeModal('marketModal')">‚úñ</button>
            </div>
            <div class="market-grid" id="marketGrid">
                <!-- Market items will be generated here -->
            </div>
        </div>
    </div>

    <!-- Factory Modal -->
    <div class="modal" id="factoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üè≠ Extract Laboratory</span>
                <button class="close-btn" onclick="closeModal('factoryModal')">‚úñ</button>
            </div>
            <div class="factory-machines">
                <div class="machine">
                    <div class="machine-icon">üß™</div>
                    <div class="machine-name">Tincture Press</div>
                    <div class="machine-status">Ready</div>
                    <div class="machine-progress">
                        <div class="machine-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="machine">
                    <div class="machine-icon">‚öóÔ∏è</div>
                    <div class="machine-name">Oil Distiller</div>
                    <div class="machine-status">Processing...</div>
                    <div class="machine-progress">
                        <div class="machine-progress-fill" style="width: 65%"></div>
                    </div>
                </div>
                <div class="machine">
                    <div class="machine-icon">üî¨</div>
                    <div class="machine-name">Extract Maker</div>
                    <div class="machine-status">Ready</div>
                    <div class="machine-progress">
                        <div class="machine-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="machine">
                    <div class="machine-icon">üíä</div>
                    <div class="machine-name">Capsule Filler</div>
                    <div class="machine-status">Locked (Lvl 15)</div>
                    <div class="machine-progress">
                        <div class="machine-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Social/Co-op Modal -->
    <div class="modal" id="socialModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üë• Medicine Co-op</span>
                <button class="close-btn" onclick="closeModal('socialModal')">‚úñ</button>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid #a855f7; padding: 10px; border-radius: 10px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">üéØ Weekly Goal: Harvest 10,000 Herbs</div>
                    <div style="font-size: 12px; margin-bottom: 5px;">Progress: 3,421/10,000</div>
                    <div style="height: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden;">
                        <div style="height: 100%; width: 34%; background: linear-gradient(90deg, #a855f7, #c084fc);"></div>
                    </div>
                </div>
            </div>
            <div class="friends-list">
                <div class="friend-item">
                    <div class="friend-avatar">üë©</div>
                    <div class="friend-info">
                        <div class="friend-name">Sarah</div>
                        <div class="friend-status">üü¢ Online - Harvesting</div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn" onclick="sendGift(1)">Gift</button>
                        <button class="action-btn" onclick="helpFriend(1)">Help</button>
                    </div>
                </div>
                <div class="friend-item">
                    <div class="friend-avatar">üë®</div>
                    <div class="friend-info">
                        <div class="friend-name">Mike</div>
                        <div class="friend-status">üî¥ Offline - 2h ago</div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn" onclick="sendGift(2)">Gift</button>
                        <button class="action-btn" onclick="helpFriend(2)">Help</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievement Toast -->
    <div class="achievement-toast" id="achievementToast">
        <div class="achievement-header">
            <span class="achievement-icon">üèÜ</span>
            <span class="achievement-title">Achievement!</span>
        </div>
        <div class="achievement-desc" id="achievementDesc">First Harvest!</div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Game State
        let gameState = {
            // Player stats
            level: 1,
            xp: 0,
            coins: 1000,
            gems: 10,
            herbs: 0,
            extracts: 0,
            energy: 100,
            maxEnergy: 100,
            currentFarm: 1,
            totalFarms: 1,
            
            // Farm data
            plots: Array(64).fill(null),
            buildings: {
                greenhouse: { level: 1, producing: false },
                lab: { level: 1, producing: false },
                apothecary: { level: 0, locked: true },
                library: { level: 0, locked: true },
                pond: { level: 0, locked: true }
            },
            
            // Social
            friends: [],
            coopProgress: 3421,
            coopGoal: 10000,
            
            // Weather
            weather: 'sunny',
            weatherBonus: 1.0,
            
            // Plants database
            plants: [
                {id: 1, name: 'Mint', emoji: 'üåø', growTime: 30, value: 10, xp: 5, level: 1},
                {id: 2, name: 'Basil', emoji: 'üå±', growTime: 45, value: 15, xp: 7, level: 1},
                {id: 3, name: 'Aloe', emoji: 'üåµ', growTime: 60, value: 25, xp: 10, level: 2},
                {id: 4, name: 'Lavender', emoji: 'üíú', growTime: 90, value: 40, xp: 15, level: 3},
                {id: 5, name: 'Echinacea', emoji: 'üå∏', growTime: 120, value: 60, xp: 20, level: 5},
                {id: 6, name: 'Ginseng', emoji: '‚≠ê', growTime: 180, value: 100, xp: 30, level: 8},
                {id: 7, name: 'Turmeric', emoji: 'üü°', growTime: 150, value: 80, xp: 25, level: 6},
                {id: 8, name: 'Ginger', emoji: 'ü´ö', growTime: 100, value: 50, xp: 18, level: 4},
                {id: 9, name: 'Chamomile', emoji: 'üåº', growTime: 70, value: 30, xp: 12, level: 2},
                {id: 10, name: 'Valerian', emoji: 'üå∫', growTime: 140, value: 70, xp: 22, level: 7}
            ],
            
            // Inventory
            inventory: {}
        };

        // Load saved game
        const saved = localStorage.getItem('canaGameState');
        if (saved) {
            gameState = {...gameState, ...JSON.parse(saved)};
        }

        // Initialize farm grid
        function initFarmGrid() {
            const grid = document.getElementById('farmGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 64; i++) {
                const plot = document.createElement('div');
                plot.className = 'plot';
                plot.id = `plot-${i}`;
                plot.onclick = () => handlePlotClick(i);
                
                if (gameState.plots[i]) {
                    updatePlot(i, gameState.plots[i]);
                }
                
                grid.appendChild(plot);
            }
        }

        // Handle plot click
        function handlePlotClick(plotId) {
            const plot = gameState.plots[plotId];
            
            if (!plot) {
                // Empty plot - plant something
                plantCrop(plotId);
            } else if (plot.ready) {
                // Ready to harvest
                harvestCrop(plotId);
            } else {
                // Still growing - show info
                showPlotInfo(plotId);
            }
        }

        // Plant crop
        function plantCrop(plotId) {
            if (gameState.energy < 5) {
                showFloatingText('Need 5 energy!', event.clientX, event.clientY, '#ef4444');
                return;
            }
            
            // Quick plant menu
            const plant = gameState.plants[Math.floor(Math.random() * Math.min(gameState.level + 2, gameState.plants.length))];
            
            if (gameState.coins < plant.value) {
                showFloatingText('Not enough coins!', event.clientX, event.clientY, '#ef4444');
                return;
            }
            
            gameState.coins -= plant.value;
            gameState.energy -= 5;
            
            gameState.plots[plotId] = {
                plant: plant,
                plantedAt: Date.now(),
                growTime: plant.growTime * 1000,
                ready: false
            };
            
            updatePlot(plotId, gameState.plots[plotId]);
            updateUI();
            saveGame();
            
            // Schedule growth
            setTimeout(() => {
                if (gameState.plots[plotId]) {
                    gameState.plots[plotId].ready = true;
                    updatePlot(plotId, gameState.plots[plotId]);
                    showFloatingText('Ready!', 0, 0, '#4ade80');
                }
            }, plant.growTime * 1000);
        }

        // Update plot display
        function updatePlot(plotId, plotData) {
            const plotEl = document.getElementById(`plot-${plotId}`);
            if (!plotEl || !plotData) return;
            
            const now = Date.now();
            const timeLeft = (plotData.plantedAt + plotData.growTime) - now;
            const ready = timeLeft <= 0;
            
            plotEl.innerHTML = '';
            
            if (plotData.plant) {
                const plantEl = document.createElement('div');
                plantEl.className = 'plot-plant';
                plantEl.textContent = plotData.plant.emoji;
                plotEl.appendChild(plantEl);
                
                if (!ready) {
                    const timerEl = document.createElement('div');
                    timerEl.className = 'plot-timer';
                    timerEl.textContent = formatTime(Math.ceil(timeLeft / 1000));
                    plotEl.appendChild(timerEl);
                    
                    // Update timer
                    setTimeout(() => updatePlot(plotId, plotData), 1000);
                } else {
                    plotEl.classList.add('plot-ready');
                    plotData.ready = true;
                }
            }
        }

        // Harvest crop
        function harvestCrop(plotId) {
            const plot = gameState.plots[plotId];
            if (!plot || !plot.ready) return;
            
            const xpGain = plot.plant.xp;
            const herbsGain = 1 + Math.floor(Math.random() * 3);
            
            gameState.xp += xpGain;
            gameState.herbs += herbsGain;
            gameState.coopProgress += herbsGain;
            
            // Add to inventory
            if (!gameState.inventory[plot.plant.id]) {
                gameState.inventory[plot.plant.id] = { plant: plot.plant, count: 0 };
               
                if (!gameState.inventory[plot.plant.id]) {
                     gameState.inventory[plot.plant.id] = {
                     plant: plot.plant,
                     quantity: 0,
                     totalHarvested: 0  // Add this
    };
}
gameState.inventory[plot.plant.id].quantity += quantity;
gameState.inventory[plot.plant.id].totalHarvested += quantity;  // Add this
            }
            gameState.inventory[plot.plant.id].count += herbsGain;
            
            // Clear plot
            gameState.plots[plotId] = null;
            document.getElementById(`plot-${plotId}`).className = 'plot';
            document.getElementById(`plot-${plotId}`).innerHTML = '';
            
            // Show rewards
            showFloatingText(`+${xpGain} XP`, event.clientX - 20, event.clientY, '#4ade80');
            showFloatingText(`+${herbsGain} ${plot.plant.emoji}`, event.clientX + 20, event.clientY, '#fbbf24');
            
            // Check level up
            checkLevelUp();
            
            // Check achievements
            if (gameState.herbs === 1) {
                showAchievement('First Harvest!');
            } else if (gameState.herbs === 100) {
                showAchievement('100 Herbs Collected!');
            }
            
            updateUI();
            saveGame();
        }

        // Check level up
        function checkLevelUp() {
            const xpNeeded = gameState.level * 100;
            if (gameState.xp >= xpNeeded) {
                gameState.level++;
                gameState.xp -= xpNeeded;
                gameState.maxEnergy += 10;
                gameState.energy = gameState.maxEnergy;
                
                showAchievement(`Level ${gameState.level}!`);
                
                // Unlock new content
                if (gameState.level === 5) {
                    gameState.buildings.apothecary.locked = false;
                    showAchievement('Apothecary Unlocked!');
                }
                if (gameState.level === 10) {
                    gameState.totalFarms = 2;
                    showAchievement('New Farm Unlocked!');
                }
            }
        }

        // Show floating text
        function showFloatingText(text, x, y, color = '#4ade80') {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.textContent = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            document.body.appendChild(el);
            
            setTimeout(() => el.remove(), 2000);
        }

        // Show achievement
        function showAchievement(text) {
            const toast = document.getElementById('achievementToast');
            document.getElementById('achievementDesc').textContent = text;
            toast.classList.add('show');
            
            if (tg) tg.HapticFeedback.notificationOccurred('success');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Format time
        function formatTime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            return `${Math.floor(seconds / 3600)}h`;
        }

        // Update UI
        function updateUI() {
            document.getElementById('playerLevel').textContent = gameState.level;
            document.getElementById('farmNumber').textContent = gameState.currentFarm;
            document.getElementById('playerXP').textContent = gameState.xp;
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('gems').textContent = gameState.gems;
            document.getElementById('herbs').textContent = gameState.herbs;
            document.getElementById('extracts').textContent = gameState.extracts;
            document.getElementById('energy').textContent = gameState.energy;
            document.getElementById('energyBar').style.width = (gameState.energy / gameState.maxEnergy * 100) + '%';
        }

        // Save game
        function saveGame() {
            localStorage.setItem('canaGameState', JSON.stringify(gameState));
        }

        // Weather system
        function updateWeather() {
            const weathers = [
                {icon: '‚òÄÔ∏è', text: 'Sunny', bonus: 1.0},
                {icon: '‚õÖ', text: 'Cloudy', bonus: 0.9},
                {icon: 'üåßÔ∏è', text: 'Rainy', bonus: 1.2},
                {icon: '‚õàÔ∏è', text: 'Stormy', bonus: 0.8},
                {icon: 'üåà', text: 'Rainbow', bonus: 1.5}
            ];
            
            const weather = weathers[Math.floor(Math.random() * weathers.length)];
            gameState.weather = weather.text;
            gameState.weatherBonus = weather.bonus;
            
            document.getElementById('weatherIcon').textContent = weather.icon;
            document.getElementById('weatherText').textContent = weather.text;
            
            if (weather.bonus > 1) {
                showFloatingText(`Weather Bonus: ${Math.round((weather.bonus - 1) * 100)}%!`, window.innerWidth / 2, 100);
            }
        }

        // Energy regeneration
        setInterval(() => {
            if (gameState.energy < gameState.maxEnergy) {
                gameState.energy = Math.min(gameState.energy + 1, gameState.maxEnergy);
                updateUI();
            }
        }, 10000); // +1 energy every 10 seconds

        // Change weather every 5 minutes
        setInterval(updateWeather, 300000);

        // Modal controls
        function showView(view) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            // Show appropriate modal
            switch(view) {
                case 'market':
                    openMarket();
                    break;
                case 'social':
                    openSocial();
                    break;
                case 'inventory':
                    openInventory();
                    break;
                case 'quests':
                    showFloatingText('Quests coming soon!', window.innerWidth / 2, 200);
                    break;
            }
        }

        function openMarket() {
            const modal = document.getElementById('marketModal');
            const grid = document.getElementById('marketGrid');
            
            grid.innerHTML = gameState.plants.filter(p => p.level <= gameState.level).map(plant => `
                <div class="market-item" onclick="buyPlantSeed(${plant.id})">
                    <div class="market-item-icon">${plant.emoji}</div>
                    <div class="market-item-name">${plant.name}</div>
                    <div class="market-item-price">üí∞ ${plant.value}</div>
                </div>
            `).join('');
            
            modal.classList.add('active');
        }

        function openFactory() {
            document.getElementById('factoryModal').classList.add('active');
        }

        function openSocial() {
            document.getElementById('socialModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Visit neighbor
        function visitNeighbor(id) {
            showFloatingText(`Visiting neighbor's farm...`, window.innerWidth / 2, 200);
            // Would load neighbor's farm view
        }

        // Initialize
        initFarmGrid();
        updateUI();
        updateWeather();

        // Auto-save every 30 seconds
        setInterval(saveGame, 30000);
    </script>
<const libraryModalHTML = `
<div class="modal" id="libraryModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <span class="modal-title">üìö Plant Encyclopedia</span>
            <button class="close-btn" onclick="closeModal('libraryModal')">‚úñ</button>
        </div>
        <div style="padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 10px; margin-bottom: 15px;">
            <input type="text" id="plantSearch" placeholder="Search plants..." 
                   style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #22c55e; 
                          border-radius: 8px; color: #e0f2e9; font-size: 14px;"
                   oninput="filterPlants()">
            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px;">
                <span>Total: <span style="color: #4ade80;">369 plants</span></span>
                <span>Discovered: <span id="discoveredCount" style="color: #fbbf24;">0</span></span>
                <span>Completion: <span id="completionPercent" style="color: #a855f7;">0%</span></span>
            </div>
        </div>
        <div id="libraryContent" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
</div>
`;
document.body.insertAdjacentHTML('beforeend', libraryModalHTML);
    function openLibrary() {
    const modal = document.getElementById('libraryModal');
    const content = document.getElementById('libraryContent');
    
    // Track discovered plants (ones that have been harvested)
    const discoveredPlants = new Set();
    Object.values(gameState.inventory).forEach(item => {
        if (item.quantity > 0 || item.plant) {
            discoveredPlants.add(item.plant ? item.plant.id : item.id);
        }
    });
    
    // Update discovery stats
    document.getElementById('discoveredCount').textContent = discoveredPlants.size;
    document.getElementById('completionPercent').textContent = 
        Math.floor((discoveredPlants.size / 369) * 100) + '%';
    
    // Generate plant cards
    let html = '<div style="display: grid; gap: 10px;">';
    
    gameState.plants.forEach(plant => {
        const isDiscovered = discoveredPlants.has(plant.id);
        const locked = plant.level > gameState.level;
        
        html += `
            <div class="library-card" style="
                background: ${isDiscovered ? 'rgba(34, 197, 94, 0.1)' : 'rgba(0, 0, 0, 0.3)'};
                border: 1px solid ${isDiscovered ? '#22c55e' : '#374151'};
                border-radius: 10px;
                padding: 12px;
                display: flex;
                align-items: center;
                gap: 15px;
                transition: all 0.3s;
                cursor: pointer;
            " onclick="showPlantDetails(${plant.id})">
                <div style="font-size: 30px; ${!isDiscovered ? 'filter: grayscale(1); opacity: 0.3;' : ''}">
                    ${plant.emoji}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: ${isDiscovered ? '#4ade80' : '#6b7280'};">
                        ${isDiscovered ? plant.name : '???'}
                    </div>
                    <div style="font-size: 11px; opacity: 0.7; font-style: italic;">
                        ${isDiscovered && plant.scientific ? plant.scientific : 'Unknown species'}
                    </div>
                    <div style="font-size: 10px; margin-top: 3px;">
                        ${locked ? 
                            `<span style="color: #ef4444;">üîí Level ${plant.level}</span>` : 
                            `<span style="color: #fbbf24;">üí∞ ${plant.value}</span> ‚Ä¢ 
                             <span style="color: #3b82f6;">‚è±Ô∏è ${plant.growTime}s</span> ‚Ä¢ 
                             <span style="color: #a855f7;">‚ú® ${plant.xp} XP</span>`
                        }
                    </div>
                </div>
                <div style="text-align: center;">
                    ${isDiscovered ? 
                        `<div style="color: #22c55e; font-size: 20px;">‚úì</div>
                         <div style="font-size: 9px;">Discovered</div>` :
                        `<div style="color: #6b7280; font-size: 20px;">?</div>
                         <div style="font-size: 9px;">Unknown</div>`
                    }
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    content.innerHTML = html;
    modal.classList.add('active');
}

// Filter plants by search
function filterPlants() {
    const searchTerm = document.getElementById('plantSearch').value.toLowerCase();
    const cards = document.querySelectorAll('.library-card');
    
    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(searchTerm) ? 'flex' : 'none';
    });
}

// Show detailed plant information
function showPlantDetails(plantId) {
    const plant = gameState.plants.find(p => p.id === plantId);
    if (!plant) return;
    
    // Check if discovered
    const isDiscovered = gameState.inventory[plantId] && gameState.inventory[plantId].quantity > 0;
    
    const detailHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 60px; margin-bottom: 10px;">${plant.emoji}</div>
            <h2 style="color: #4ade80; margin-bottom: 5px;">${isDiscovered ? plant.name : '???'}</h2>
            <div style="font-style: italic; opacity: 0.8; margin-bottom: 15px;">
                ${isDiscovered && plant.scientific ? plant.scientific : 'Unknown species'}
            </div>
            
            ${isDiscovered ? `
                <div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left;">
                        <div><strong>Growth Time:</strong> ${plant.growTime} seconds</div>
                        <div><strong>Buy Price:</strong> üí∞ ${plant.value}</div>
                        <div><strong>Sell Price:</strong> üí∞ ${plant.value * 3}</div>
                        <div><strong>Experience:</strong> ‚ú® ${plant.xp} XP</div>
                        <div><strong>Unlock Level:</strong> ${plant.level}</div>
                        <div><strong>Rarity:</strong> ${getRarityFromLevel(plant.level)}</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <strong>Times Harvested:</strong> ${gameState.inventory[plantId]?.totalHarvested || 0}
                </div>
            ` : `
                <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 10px;">
                    <div style="color: #ef4444;">üîí Plant not yet discovered!</div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        Unlocks at Level ${plant.level}
                    </div>
                </div>
            `}
            
            <button class="item-action" onclick="closeModal('libraryModal'); openplantLibrary();" 
                    style="margin-top: 15px;">
                Back to Library
            </button>
        </div>
    `;
    
    // Show in a temporary modal overlay
    const detailModal = document.createElement('div');
    detailModal.className = 'modal active';
    detailModal.style.zIndex = '3000';
    detailModal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            ${detailHTML}
        </div>
    `;
    detailModal.onclick = function(e) {
        if (e.target === detailModal) {
            detailModal.remove();
        }
    };
    document.body.appendChild(detailModal);
}

// Helper function for rarity
function getRarityFromLevel(level) {
    if (level <= 5) return '‚ö™ Common';
    if (level <= 10) return 'üü¢ Uncommon';
    if (level <= 15) return 'üîµ Rare';
    if (level <= 20) return 'üü£ Epic';
    return 'üü° Legendary';
}
</body>
</html>
