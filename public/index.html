<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>CANA Coin Farm - Telegram Edition</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      color: #fff;
    }
    
    /* Telegram theme integration */
    .tg-themed {
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
    }
    
    /* Loading screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    
    .loading-logo {
      font-size: 4em;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .loading-text {
      margin-top: 20px;
      font-size: 1.2em;
      opacity: 0.9;
    }
    
    .loading-bar {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      margin-top: 20px;
      overflow: hidden;
    }
    
    .loading-progress {
      height: 100%;
      background: white;
      width: 0%;
      animation: load 2s forwards;
    }
    
    @keyframes load {
      to { width: 100%; }
    }
    
    /* Game container */
    .game-container {
      display: none;
      min-height: 100vh;
      position: relative;
    }
    
    /* Top navigation bar */
    .top-bar {
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .player-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
    }
    
    .player-stats {
      display: flex;
      flex-direction: column;
    }
    
    .player-name {
      font-weight: bold;
      font-size: 0.9em;
    }
    
    .player-level {
      font-size: 0.8em;
      opacity: 0.8;
    }
    
    .resources {
      display: flex;
      gap: 15px;
    }
    
    .resource {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(255,255,255,0.1);
      padding: 5px 10px;
      border-radius: 20px;
    }
    
    .resource-icon {
      font-size: 1.2em;
    }
    
    .resource-value {
      font-weight: bold;
    }
    
    /* Main game view */
    .game-view {
      padding: 10px;
      padding-bottom: 80px;
    }
    
    /* 3D Farm perspective */
    .farm-3d {
      perspective: 1000px;
      margin: 20px 0;
    }
    
    .farm-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      transform: rotateX(30deg);
      transform-style: preserve-3d;
    }
    
    .plot-3d {
      aspect-ratio: 1;
      background: linear-gradient(135deg, #8BC34A, #4CAF50);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
      transform-style: preserve-3d;
      position: relative;
    }
    
    .plot-3d:active {
      transform: translateZ(20px) scale(0.95);
    }
    
    .plot-3d.planted {
      background: linear-gradient(135deg, #FFE082, #FFD54F);
    }
    
    .plot-3d.ready {
      background: linear-gradient(135deg, #66BB6A, #43A047);
      animation: readyPulse 2s infinite;
    }
    
    @keyframes readyPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(102, 187, 106, 0.8); }
      50% { box-shadow: 0 0 20px 10px rgba(102, 187, 106, 0.4); }
    }
    
    .plant-model {
      font-size: 3em;
      margin-bottom: 5px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .plant-info {
      font-size: 0.8em;
      text-align: center;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .plant-timer {
      font-size: 0.7em;
      background: rgba(0,0,0,0.3);
      padding: 2px 6px;
      border-radius: 10px;
      margin-top: 3px;
    }
    
    /* Region selector */
    .region-selector {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px 0;
      margin-bottom: 20px;
    }
    
    .region-card {
      min-width: 120px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .region-card.active {
      background: rgba(255,255,255,0.2);
      border-color: #FFD700;
      transform: scale(1.05);
    }
    
    .region-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .region-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }
    
    .region-name {
      font-size: 0.9em;
      font-weight: bold;
    }
    
    .region-level {
      font-size: 0.8em;
      opacity: 0.8;
    }
    
    /* Action buttons */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .action-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      padding: 15px;
      border-radius: 15px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .action-btn:active {
      transform: scale(0.95);
    }
    
    .action-btn.harvest {
      background: linear-gradient(135deg, #66BB6A, #43A047);
    }
    
    .action-btn.water {
      background: linear-gradient(135deg, #42A5F5, #1E88E5);
    }
    
    .action-btn.fertilize {
      background: linear-gradient(135deg, #AB47BC, #8E24AA);
    }
    
    /* Bottom navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 100;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      padding: 5px 15px;
      cursor: pointer;
      transition: all 0.3s;
      color: rgba(255,255,255,0.7);
    }
    
    .nav-item.active {
      color: #FFD700;
    }
    
    .nav-icon {
      font-size: 1.5em;
    }
    
    .nav-label {
      font-size: 0.7em;
    }
    
    /* Plant selection modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
      flex-direction: column;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      border-radius: 20px;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      margin: auto;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .plant-list {
      display: grid;
      gap: 10px;
    }
    
    .plant-item {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .plant-item:active {
      background: rgba(255,255,255,0.2);
      transform: scale(0.98);
    }
    
    .plant-details {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .plant-emoji {
      font-size: 2em;
    }
    
    .plant-text {
      display: flex;
      flex-direction: column;
    }
    
    .plant-name {
      font-weight: bold;
    }
    
    .plant-latin {
      font-size: 0.8em;
      opacity: 0.7;
      font-style: italic;
    }
    
    .plant-stats {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      font-size: 0.8em;
    }
    
    .plant-stat {
      background: rgba(255,255,255,0.2);
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    .plant-cost {
      background: rgba(255,215,0,0.3);
      padding: 5px 10px;
      border-radius: 10px;
      font-weight: bold;
    }
    
    /* Quest notification */
    .quest-popup {
      position: fixed;
      top: 70px;
      right: 10px;
      background: linear-gradient(135deg, #FFD700, #FFA000);
      color: #000;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      display: none;
      animation: slideIn 0.5s;
      max-width: 250px;
    }
    
    @keyframes slideIn {
      from { transform: translateX(300px); }
      to { transform: translateX(0); }
    }
    
    .quest-popup.show {
      display: block;
    }
    
    /* Experience bar */
    .xp-bar {
      background: rgba(0,0,0,0.3);
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin: 10px;
    }
    
    .xp-fill {
      background: linear-gradient(90deg, #FFD700, #FFA000);
      height: 100%;
      transition: width 0.5s;
    }
    
    /* Floating numbers animation */
    .floating-number {
      position: fixed;
      font-size: 1.5em;
      font-weight: bold;
      pointer-events: none;
      animation: floatUp 2s forwards;
    }
    
    @keyframes floatUp {
      to {
        transform: translateY(-100px);
        opacity: 0;
      }
    }
    
    .floating-number.coins {
      color: #FFD700;
    }
    
    .floating-number.xp {
      color: #00E676;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">üåø</div>
    <div class="loading-text">CANA Coin Farm</div>
    <div class="loading-bar">
      <div class="loading-progress"></div>
    </div>
  </div>
  
  <!-- Game Container -->
  <div class="game-container" id="gameContainer">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="player-info">
        <div class="player-avatar" id="playerAvatar">üë§</div>
        <div class="player-stats">
          <div class="player-name" id="playerName">Loading...</div>
          <div class="player-level">Level <span id="playerLevel">1</span></div>
        </div>
      </div>
      <div class="resources">
        <div class="resource">
          <span class="resource-icon">üí∞</span>
          <span class="resource-value" id="coins">0</span>
        </div>
        <div class="resource">
          <span class="resource-icon">üíé</span>
          <span class="resource-value" id="gems">0</span>
        </div>
        <div class="resource">
          <span class="resource-icon">‚ö°</span>
          <span class="resource-value" id="energy">100</span>
        </div>
      </div>
    </div>
    
    <!-- XP Bar -->
    <div class="xp-bar">
      <div class="xp-fill" id="xpBar" style="width: 0%"></div>
    </div>
    
    <!-- Main Game View -->
    <div class="game-view">
      <!-- Region Selector -->
      <div class="region-selector" id="regionSelector">
        <div class="region-card active" data-region="1">
          <div class="region-icon">üå≥</div>
          <div class="region-name">Amazon</div>
          <div class="region-level">Lv. 1</div>
        </div>
        <div class="region-card" data-region="2">
          <div class="region-icon">üèîÔ∏è</div>
          <div class="region-name">Himalayas</div>
          <div class="region-level">Lv. 5</div>
        </div>
        <div class="region-card locked" data-region="3">
          <div class="region-icon">üåµ</div>
          <div class="region-name">Sahara</div>
          <div class="region-level">Lv. 10</div>
        </div>
        <div class="region-card locked" data-region="4">
          <div class="region-icon">üåä</div>
          <div class="region-name">Pacific</div>
          <div class="region-level">Lv. 15</div>
        </div>
      </div>
      
      <!-- 3D Farm Grid -->
      <div class="farm-3d">
        <div class="farm-grid" id="farmGrid">
          <!-- Plots will be generated here -->
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="action-btn harvest" onclick="harvestAll()">
          <span>üåæ</span> Harvest All
        </button>
        <button class="action-btn water" onclick="waterAll()">
          <span>üíß</span> Water All
        </button>
        <button class="action-btn fertilize" onclick="openShop()">
          <span>üõí</span> Shop
        </button>
        <button class="action-btn" onclick="openQuests()">
          <span>üìú</span> Quests
        </button>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchTab('farm')">
        <span class="nav-icon">üå±</span>
        <span class="nav-label">Farm</span>
      </div>
      <div class="nav-item" onclick="switchTab('inventory')">
        <span class="nav-icon">üéí</span>
        <span class="nav-label">Inventory</span>
      </div>
      <div class="nav-item" onclick="switchTab('library')">
        <span class="nav-icon">üìö</span>
        <span class="nav-label">Library</span>
      </div>
      <div class="nav-item" onclick="switchTab('social')">
        <span class="nav-icon">üë•</span>
        <span class="nav-label">Social</span>
      </div>
      <div class="nav-item" onclick="switchTab('profile')">
        <span class="nav-icon">üë§</span>
        <span class="nav-label">Profile</span>
      </div>
    </div>
  </div>
  
  <!-- Plant Selection Modal -->
  <div class="modal" id="plantModal">
    <div class="modal-content">
      <div class="modal-header">üåø Select Plant to Grow</div>
      <div class="plant-list" id="plantList">
        <!-- Plants will be loaded here -->
      </div>
      <button onclick="closeModal()" style="width: 100%; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 10px; color: white; font-weight: bold;">Cancel</button>
    </div>
  </div>
  
  <!-- Quest Popup -->
  <div class="quest-popup" id="questPopup">
    <div style="font-weight: bold; margin-bottom: 5px;">üéØ Quest Complete!</div>
    <div id="questMessage">You earned 100 coins!</div>
  </div>
  
  <script>
    // Telegram WebApp initialization
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // Game state
    let gameState = {
      user: null,
      farms: [],
      currentRegion: 1,
      selectedPlot: null,
      plants: []
    };
    
    // Initialize game
    async function initGame() {
      // Authenticate with Telegram data
      const initData = tg.initData || '';
      const user = tg.initDataUnsafe.user || { id: 1, first_name: 'Player' };
      
      try {
        // Send auth to backend
        const authResponse = await fetch('/api/telegram/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData })
        });
        
        const authData = await authResponse.json();
        if (authData.success) {
          gameState.user = authData.user;
          
          // Load game state
          await loadGameState();
          
          // Load plants
          await loadPlants();
          
          // Show game
          document.getElementById('loadingScreen').style.opacity = '0';
          setTimeout(() => {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
          }, 500);
          
          // Update UI
          updateUI();
          
          // Start timers
          setInterval(updateTimers, 1000);
        }
      } catch (error) {
        console.error('Init error:', error);
        // Fallback for testing
        gameState.user = { id: 1, username: 'TestPlayer', coins: 1000, gems: 10, level: 1, experience: 0 };
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'block';
        initializeFarm();
        updateUI();
      }
    }
    
    // Load game state from server
    async function loadGameState() {
      try {
        const response = await fetch(`/api/game/state/${gameState.user.id}`);
        const data = await response.json();
        gameState = { ...gameState, ...data };
      } catch (error) {
        console.error('Error loading game state:', error);
      }
    }
    
    // Load plants library
    async function loadPlants() {
      try {
        const response = await fetch('/api/plants/library');
        gameState.plants = await response.json();
      } catch (error) {
        console.error('Error loading plants:', error);
        // Fallback plants
        gameState.plants = [
          { id: 1, common_name: 'Aloe Vera', scientific_name: 'Aloe barbadensis', growth_time: 30, base_price: 15 },
          { id: 2, common_name: 'Chamomile', scientific_name: 'Matricaria chamomilla', growth_time: 45, base_price: 20 },
          { id: 3, common_name: 'Lavender', scientific_name: 'Lavandula', growth_time: 60, base_price: 25 }
        ];
      }
    }
    
    // Update UI
    function updateUI() {
      if (!gameState.user) return;
      
      // Update player info
      document.getElementById('playerName').textContent = gameState.user.first_name || gameState.user.username;
      document.getElementById('playerLevel').textContent = gameState.user.level;
      document.getElementById('coins').textContent = gameState.user.coins;
      document.getElementById('gems').textContent = gameState.user.gems;
      document.getElementById('energy').textContent = gameState.user.energy;
      
      // Update XP bar
      const xpForLevel = gameState.user.level * 100;
      const xpProgress = (gameState.user.experience % xpForLevel) / xpForLevel * 100;
      document.getElementById('xpBar').style.width = xpProgress + '%';
      
      // Update farm
      renderFarm();
    }
    
    // Initialize farm plots
    function initializeFarm() {
      const farmGrid = document.getElementById('farmGrid');
      farmGrid.innerHTML = '';
      
      for (let i = 1; i <= 9; i++) {
        const plot = document.createElement('div');
        plot.className = 'plot-3d';
        plot.dataset.plotId = i;
        plot.innerHTML = `
          <div class="plant-model">üå±</div>
          <div class="plant-info">Plot ${i}</div>
        `;
        plot.onclick = () => selectPlot(i);
        farmGrid.appendChild(plot);
      }
    }
    
    // Render farm with actual data
    function renderFarm() {
      const farmGrid = document.getElementById('farmGrid');
      farmGrid.innerHTML = '';
      
      const regionFarms = gameState.farms?.filter(f => f.region_id == gameState.currentRegion) || [];
      
      for (let i = 1; i <= 9; i++) {
        const farm = regionFarms.find(f => f.plot_number === i);
        const plot = document.createElement('div');
        plot.className = 'plot-3d';
        plot.dataset.plotId = i;
        
        if (farm && farm.plant_id) {
          const now = new Date();
          const ready = new Date(farm.ready_at);
          const isReady = now >= ready;
          
          if (isReady) {
            plot.classList.add('ready');
            plot.innerHTML = `
              <div class="plant-model">üåæ</div>
              <div class="plant-info">${farm.common_name || 'Plant'}</div>
              <div class="plant-timer">Ready!</div>
            `;
            plot.onclick = () => harvest(i);
          } else {
            plot.classList.add('planted');
            const timeLeft = Math.ceil((ready - now) / 1000);
            plot.innerHTML = `
              <div class="plant-model">üå±</div>
              <div class="plant-info">${farm.common_name || 'Plant'}</div>
              <div class="plant-timer" data-time="${timeLeft}">${formatTime(timeLeft)}</div>
            `;
          }
        } else {
          plot.innerHTML = `
            <div class="plant-model">üå±</div>
            <div class="plant-info">Empty</div>
          `;
          plot.onclick = () => selectPlot(i);
        }
        
        farmGrid.appendChild(plot);
      }
    }
    
    // Select plot for planting
    function selectPlot(plotId) {
      gameState.selectedPlot = plotId;
      showPlantModal();
    }
    
    // Show plant selection modal
    function showPlantModal() {
      const modal = document.getElementById('plantModal');
      const list = document.getElementById('plantList');
      
      list.innerHTML = '';
      
      gameState.plants.forEach(plant => {
        const item = document.createElement('div');
        item.className = 'plant-item';
        item.innerHTML = `
          <div class="plant-details">
            <div class="plant-emoji">üåø</div>
            <div class="plant-text">
              <div class="plant-name">${plant.common_name}</div>
              <div class="plant-latin">${plant.scientific_name || ''}</div>
              <div class="plant-stats">
                <span class="plant-stat">‚è±Ô∏è ${plant.growth_time}s</span>
                <span class="plant-stat">üí∞ ${plant.base_price * 3}</span>
              </div>
            </div>
          </div>
          <div class="plant-cost">üí∞ ${plant.base_price}</div>
        `;
        item.onclick = () => plantSeed(plant.id);
        list.appendChild(item);
      });
      
      modal.classList.add('active');
    }
    
    // Plant seed
    async function plantSeed(plantId) {
      if (!gameState.selectedPlot) return;
      
      try {
        const response = await fetch('/api/game/plant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: gameState.user.id,
            plantId: plantId,
            plotId: gameState.selectedPlot
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Show floating number
          showFloatingNumber('-' + gameState.plants.find(p => p.id === plantId).base_price, 'coins');
          
          // Haptic feedback
          if (tg.HapticFeedback) {
            tg.HapticFeedback.impactOccurred('light');
          }
          
          // Reload game state
          await loadGameState();
          updateUI();
        } else {
          tg.showAlert(result.message);
        }
      } catch (error) {
        console.error('Error planting:', error);
      }
      
      closeModal();
    }
    
    // Harvest crop
    async function harvest(plotId) {
      try {
        const response = await fetch('/api/game/harvest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: gameState.user.id,
            plotId: plotId
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Show floating numbers
          showFloatingNumber('+' + result.coins, 'coins');
          showFloatingNumber('+' + result.xp, 'xp');
          
          // Haptic feedback
          if (tg.HapticFeedback) {
            tg.HapticFeedback.notificationOccurred('success');
          }
          
          // Check for level up
          if (result.levelUp) {
            showQuestPopup(`LEVEL UP! You're now level ${result.newLevel}!`);
          }
          
          // Reload game state
          await loadGameState();
          updateUI();
        }
      } catch (error) {
        console.error('Error harvesting:', error);
      }
    }
    
    // Harvest all ready crops
    async function harvestAll() {
      const readyPlots = document.querySelectorAll('.plot-3d.ready');
      for (const plot of readyPlots) {
        await harvest(parseInt(plot.dataset.plotId));
      }
    }
    
    // Close modal
    function closeModal() {
      document.getElementById('plantModal').classList.remove('active');
    }
    
    // Show floating number animation
    function showFloatingNumber(text, type) {
      const num = document.createElement('div');
      num.className = `floating-number ${type}`;
      num.textContent = text;
      num.style.left = Math.random() * window.innerWidth + 'px';
      num.style.top = window.innerHeight / 2 + 'px';
      document.body.appendChild(num);
      
      setTimeout(() => num.remove(), 2000);
    }
    
    // Show quest popup
    function showQuestPopup(message) {
      const popup = document.getElementById('questPopup');
      document.getElementById('questMessage').textContent = message;
      popup.classList.add('show');
      
      setTimeout(() => {
        popup.classList.remove('show');
      }, 3000);
    }
    
    // Format time
    function formatTime(seconds) {
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Update timers
    function updateTimers() {
      document.querySelectorAll('[data-time]').forEach(timer => {
        let time = parseInt(timer.dataset.time);
        if (time > 0) {
          time--;
          timer.dataset.time = time;
          timer.textContent = formatTime(time);
          
          if (time === 0) {
            // Crop is ready!
            const plot = timer.closest('.plot-3d');
            plot.classList.remove('planted');
            plot.classList.add('ready');
            timer.textContent = 'Ready!';
            
            // Notification
            if (tg.HapticFeedback) {
              tg.HapticFeedback.notificationOccurred('success');
            }
          }
        }
      });
    }
    
    // Tab switching
    function switchTab(tab) {
      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.nav-item').classList.add('active');
      
      // Haptic feedback
      if (tg.HapticFeedback) {
        tg.HapticFeedback.selectionChanged();
      }
      
      // Load tab content (implement as needed)
      tg.showAlert(`${tab} tab coming soon!`);
    }
    
    // Water all plants
    function waterAll() {
      tg.showAlert('Watering feature coming soon!');
    }
    
    // Open shop
    function openShop() {
      tg.showAlert('Shop coming soon with 400+ plants!');
    }
    
    // Open quests
    function openQuests() {
      tg.showAlert('Daily quests coming soon!');
    }
    
    // Initialize game on load
    window.addEventListener('load', initGame);
    
    // Handle back button
    tg.BackButton.onClick(() => {
      if (document.querySelector('.modal.active')) {
        closeModal();
      } else {
        tg.close();
      }
    });
  </script>
</body>
</html>
